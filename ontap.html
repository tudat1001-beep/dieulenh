<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ôn luyện 114 câu hỏi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
            },
            secondary: {
              50: '#f0fdf4',
              500: '#22c55e',
              600: '#16a34a',
              700: '#15803d',
            }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .section-card {
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    
    .section-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .question-card {
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    
    .question-card.active {
      border-left-color: #3b82f6;
      background-color: #f8fafc;
    }
    
    .option-label {
      transition: all 0.2s ease;
    }
    
    .option-label:hover {
      background-color: #f8fafc;
    }
    
    .progress-bar {
      height: 6px;
      background-color: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #10b981;
      transition: width 0.5s ease;
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Mobile optimizations */
    @media (max-width: 640px) {
      .mobile-padding {
        padding: 1rem;
      }
      
      .mobile-sticky-footer {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1rem;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }
      
      .mobile-flex-col {
        flex-direction: column;
      }
      
      .mobile-text-center {
        text-align: center;
      }
      
      .mobile-full-width {
        width: 100%;
      }
      
      .question-card {
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .option-label {
        padding: 0.75rem;
      }
    }
    
    /* Custom scrollbar for webkit browsers */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Navigation styles */
    .nav-tab {
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    
    .nav-tab.active {
      border-bottom-color: #3b82f6;
      color: #3b82f6;
      font-weight: 600;
    }
    
    /* Answer feedback styles */
    .correct-answer {
      background-color: #f0fdf4 !important;
      border-color: #22c55e !important;
    }
    
    .incorrect-answer {
      background-color: #fef2f2 !important;
      border-color: #ef4444 !important;
    }
    
    .correct-indicator {
      background-color: #22c55e !important;
    }
    
    .incorrect-indicator {
      background-color: #ef4444 !important;
    }
  </style>
  <script>
    // ====== CẤU HÌNH ======
    const CONFIG = {
      API_URL: 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgrodM46l_uOAZqVHZeqgaTRkzoUYleBw_JyYdjR6HeRNMn3VEPgSULB75ZC0aqHHTeszDoV5KiE8oADb0Z6dqpXoXPy_HMAWgmKku0WAdBB6GxxHBoYoI4cj4bG6sz6Ll3_xmLPhj7mHudY8D151TAxgg5gz-0g4lgrZqgzewM58q-0_O31OsiC82W4MAaEGweqvQ8rl54aSC3GwdpDIHUvJCfLUTofC-LpfkVZWM8IzBTDW-Be0BOfVIG3i0B3y3OOhqe2ULznWi41P_hvlAEG9T9cxRlR2rC8B42&lib=Mw0eLkIm6DcV6jI3Xq4qdLdG2gI_JdtU5',
      TOTAL_QUESTIONS: 114,
      SECTIONS: 5
    };

    // ====== TIỆN ÍCH ======
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    
    function normalize(str) {
      return (str || '').toString().trim();
    }
    
    function escapeHtml(str) {
      return (str || '').toString().replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    // ====== TRẠNG THÁI ỨNG DỤNG ======
    let ALL_QUESTIONS = [];
    let CURRENT_SECTION = 1;
    let SECTION_QUESTIONS = [];

    async function loadData() {
      setStatus('Đang tải dữ liệu', 'loading');
      try {
        const res = await fetch(CONFIG.API_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('Không truy cập được API. Kiểm tra URL Web App và quyền triển khai.');
        const json = await res.json();
        if (json.status !== 'ok' || !Array.isArray(json.data)) throw new Error('Phản hồi không hợp lệ.');
        
        // Chuẩn hoá sang cấu trúc sử dụng trong UI
        ALL_QUESTIONS = json.data.map((r, i) => {
          const options = [];
          if (normalize(r.A)) options.push({ key: 'A', text: normalize(r.A) });
          if (normalize(r.B)) options.push({ key: 'B', text: normalize(r.B) });
          if (normalize(r.C)) options.push({ key: 'C', text: normalize(r.C) });
          if (normalize(r.D)) options.push({ key: 'D', text: normalize(r.D) });
          return {
            id: normalize(r["Số câu"]) || String(i + 1),
            question: normalize(r["Câu hỏi"]) || '',
            options,
            answer: normalize(r["Đáp án (chữ)"]).toUpperCase()
          };
        }).filter(q => q.question && q.options.length);

        // Chia câu hỏi thành 5 phần
        organizeQuestionsIntoSections();
        setStatus(`Đã nạp ${ALL_QUESTIONS.length} câu hỏi. Chọn phần để bắt đầu ôn luyện.`, 'success');
        renderSectionNavigation();
        loadSection(1);
      } catch (err) {
        console.error(err);
        setStatus('Lỗi: ' + err.message, 'error');
      }
    }

    function organizeQuestionsIntoSections() {
      const questionsPerSection = Math.ceil(ALL_QUESTIONS.length / CONFIG.SECTIONS);
      
      for (let i = 0; i < CONFIG.SECTIONS; i++) {
        const startIndex = i * questionsPerSection;
        const endIndex = Math.min(startIndex + questionsPerSection, ALL_QUESTIONS.length);
        const sectionQuestions = ALL_QUESTIONS.slice(startIndex, endIndex);
        
        // Lưu thông tin phần
        if (!window.QUESTION_SECTIONS) window.QUESTION_SECTIONS = [];
        window.QUESTION_SECTIONS.push({
          number: i + 1,
          questions: sectionQuestions,
          startQuestion: startIndex + 1,
          endQuestion: endIndex,
          totalQuestions: sectionQuestions.length
        });
      }
    }

    function setStatus(msg, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = msg;
      
      // Xóa lớp cũ
      statusEl.className = 'mb-3 text-sm transition-all duration-300';
      
      // Thêm lớp mới dựa trên loại thông báo
      if (type === 'loading') {
        statusEl.classList.add('text-blue-600');
      } else if (type === 'success') {
        statusEl.classList.add('text-green-600');
      } else if (type === 'error') {
        statusEl.classList.add('text-red-600', 'font-medium');
      } else {
        statusEl.classList.add('text-gray-700');
      }
    }

    function renderSectionNavigation() {
      const container = document.getElementById('section-navigation');
      container.innerHTML = '';
      
      window.QUESTION_SECTIONS.forEach(section => {
        const tab = document.createElement('div');
        tab.className = `nav-tab px-4 py-2 cursor-pointer text-center ${section.number === CURRENT_SECTION ? 'active' : ''}`;
        tab.innerHTML = `
          <div class="font-semibold">Phần ${section.number}</div>
          <div class="text-xs text-gray-500">Câu ${section.startQuestion}-${section.endQuestion}</div>
        `;
        tab.addEventListener('click', () => loadSection(section.number));
        container.appendChild(tab);
      });
    }

    function loadSection(sectionNumber) {
      CURRENT_SECTION = sectionNumber;
      SECTION_QUESTIONS = window.QUESTION_SECTIONS[sectionNumber - 1].questions;
      
      // Cập nhật navigation
      renderSectionNavigation();
      
      // Hiển thị thông tin phần
      document.getElementById('section-info').textContent = 
        `Phần ${sectionNumber}: Câu ${window.QUESTION_SECTIONS[sectionNumber-1].startQuestion} - ${window.QUESTION_SECTIONS[sectionNumber-1].endQuestion}`;
      
      // Hiển thị câu hỏi
      renderQuestions(SECTION_QUESTIONS);
      
      setStatus(`Đang ôn luyện phần ${sectionNumber}. Chọn đáp án để kiểm tra ngay.`, 'info');
    }

    function renderQuestions(list) {
      const container = document.getElementById('questions');
      container.innerHTML = '';
      
      list.forEach((q, idx) => {
        const qId = `q_${idx}`;
        const globalIndex = (CURRENT_SECTION - 1) * Math.ceil(ALL_QUESTIONS.length / CONFIG.SECTIONS) + idx;
        
        const block = document.createElement('div');
        block.className = 'question-card mb-6 p-6 rounded-xl shadow-sm bg-white fade-in';
        block.id = `question-${globalIndex}`;
        block.innerHTML = `
          <div class="flex items-start gap-3 mb-4">
            <div class="flex-shrink-0 w-8 h-8 bg-primary-50 text-primary-600 rounded-full flex items-center justify-center font-semibold">${globalIndex + 1}</div>
            <div class="font-medium text-gray-800">${escapeHtml(q.question)}</div>
          </div>
          <div class="space-y-3 ml-11">
            ${q.options.map(opt => `
              <label class="option-label flex items-start gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer">
                <input type="radio" name="${qId}" value="${opt.key}" class="mt-1 hidden">
                <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center radio-indicator">
                  <div class="w-3 h-3 rounded-full bg-white"></div>
                </div>
                <span class="flex-1"><span class="font-semibold mr-2">${opt.key}.</span> <span>${escapeHtml(opt.text)}</span></span>
              </label>
            `).join('')}
          </div>
          <div class="mt-4 p-3 bg-gray-50 rounded-lg hidden answer-feedback">
            <div class="flex items-center gap-2 text-sm font-medium">
              <i class="fas fa-info-circle text-blue-500"></i>
              <span>Đáp án đúng: <span class="font-bold text-green-600 correct-answer-text">${q.answer}</span></span>
            </div>
          </div>
        `;
        container.appendChild(block);
        
        // Thêm sự kiện cho các input radio
        const radioInputs = block.querySelectorAll('input[type="radio"]');
        radioInputs.forEach(input => {
          input.addEventListener('change', function() {
            checkAnswer(this, q);
          });
        });
      });
      
      // Thêm hiệu ứng cho radio buttons tùy chỉnh
      document.querySelectorAll('.option-label').forEach(label => {
        label.addEventListener('click', function() {
          const radio = this.querySelector('input[type="radio"]');
          if (radio && !radio.checked) {
            radio.checked = true;
            
            // Tìm câu hỏi tương ứng
            const questionBlock = this.closest('.question-card');
            const questionIndex = Array.from(questionBlock.parentElement.children).indexOf(questionBlock);
            const question = SECTION_QUESTIONS[questionIndex];
            
            checkAnswer(radio, question);
          }
        });
      });
    }

    function checkAnswer(selectedRadio, question) {
      const selectedValue = selectedRadio.value;
      const isCorrect = selectedValue === question.answer;
      
      // Tìm phần tử cha chứa câu hỏi
      const questionBlock = selectedRadio.closest('.question-card');
      const labels = questionBlock.querySelectorAll('.option-label');
      const feedback = questionBlock.querySelector('.answer-feedback');
      
      // Đánh dấu câu hỏi đang active
      document.querySelectorAll('.question-card').forEach(card => {
        card.classList.remove('active');
      });
      questionBlock.classList.add('active');
      
      // Reset tất cả các option
      labels.forEach(label => {
        label.classList.remove('correct-answer', 'incorrect-answer');
        const indicator = label.querySelector('.radio-indicator');
        indicator.classList.remove('correct-indicator', 'incorrect-indicator');
        indicator.querySelector('div').classList.remove('bg-primary-500', 'correct-indicator', 'incorrect-indicator');
      });
      
      // Đánh dấu đáp án đúng
      const correctLabel = Array.from(labels).find(label => 
        label.querySelector('input').value === question.answer
      );
      if (correctLabel) {
        correctLabel.classList.add('correct-answer');
        const indicator = correctLabel.querySelector('.radio-indicator');
        indicator.classList.add('correct-indicator');
        indicator.querySelector('div').classList.add('correct-indicator');
      }
      
      // Đánh dấu đáp án đã chọn (nếu sai)
      if (!isCorrect) {
        const selectedLabel = selectedRadio.closest('.option-label');
        selectedLabel.classList.add('incorrect-answer');
        const indicator = selectedLabel.querySelector('.radio-indicator');
        indicator.classList.add('incorrect-indicator');
        indicator.querySelector('div').classList.add('incorrect-indicator');
      }
      
      // Hiển thị feedback
      feedback.classList.remove('hidden');
      
      // Cuộn đến câu hỏi nếu cần
      questionBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function navigateToPreviousSection() {
      if (CURRENT_SECTION > 1) {
        loadSection(CURRENT_SECTION - 1);
      }
    }

    function navigateToNextSection() {
      if (CURRENT_SECTION < CONFIG.SECTIONS) {
        loadSection(CURRENT_SECTION + 1);
      }
    }

    window.addEventListener('DOMContentLoaded', loadData);
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
  <div class="max-w-4xl mx-auto mobile-padding">
    <header class="text-center mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Ôn luyện 114 câu hỏi</h1>
      <p class="text-sm md:text-base text-gray-600">Chọn đáp án để kiểm tra kết quả</p>
    </header>

    <section class="mb-6 bg-white rounded-2xl shadow-sm p-4 md:p-6">
      <div id="section-navigation" class="flex mb-4 overflow-x-auto"></div>
      
      <div class="flex justify-between items-center mb-4">
        <button onclick="navigateToPreviousSection()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 font-medium flex items-center gap-2 transition-all hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed" id="btn-prev">
          <i class="fas fa-chevron-left"></i>
          Phần trước
        </button>
        
        <div id="section-info" class="font-semibold text-gray-800 mx-2 text-center"></div>
        
        <button onclick="navigateToNextSection()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 font-medium flex items-center gap-2 transition-all hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed" id="btn-next">
          Phần sau
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      
      <div class="mt-4">
        <div id="status" class="mb-3 text-sm text-gray-700">Chuẩn bị nạp dữ liệu…</div>
      </div>
    </section>

    <main id="questions" class="mb-6"></main>

    <footer class="text-center text-xs text-gray-500 mt-6 pt-4 border-t border-gray-200 mobile-text-center">
      <p>Ứng dụng ôn luyện - Chọn đáp án để xem kết quả ngay lập tức</p>
      <p class="mt-2"></p>
    </footer>
  </div>

  <script>
    // Cập nhật trạng thái nút điều hướng
    function updateNavigationButtons() {
      document.getElementById('btn-prev').disabled = CURRENT_SECTION <= 1;
      document.getElementById('btn-next').disabled = CURRENT_SECTION >= CONFIG.SECTIONS;
    }
    
    // Ghi đè hàm loadSection để cập nhật nút điều hướng
    const originalLoadSection = loadSection;
    loadSection = function(sectionNumber) {
      originalLoadSection(sectionNumber);
      updateNavigationButtons();
    };
  </script>
</body>
</html>
